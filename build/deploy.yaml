parameters:
- name: acr_name
  type: string
  default: 'acr_name' # Default Azure Container Registry name
trigger: none
pool:
  name: Linux-sh-pool
stages:
- stage: CloneAndPublish
  displayName: "Clone Repository and Publish"
  jobs:
  - job: CloneJob
    displayName: "Clone and Publish Job"
    variables:
      Build.ArtifactStagingDirectory: $(Pipeline.Workspace)/artifacts
    steps:
    # Step 1: Clone the Ghost Repository
    - script: |
        echo "Cloning Ghost repository..."
        git clone https://github.com/isahurtado97/Ghost.git $(Pipeline.Workspace)/artifacts/Ghost
        echo "Repository cloned successfully."
      displayName: "Clone Ghost Repository"

    # Step 2: Calculate Artifact Version
    - script: |
        echo "Calculating artifact version..."
        echo "##vso[task.setvariable variable=ArtifactVersion]ghost-$(Build.BuildId)"
        echo "Artifact Version: ghost-$(Build.BuildId)"
      displayName: "Calculate Artifact Version"

    # Step 3: Publish the Repository as an Artifact
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: $(Pipeline.Workspace)/artifacts/Ghost
        artifact: GhostRepo-$(Build.BuildId) # Use a fixed prefix with dynamic version
      displayName: "Publish Repository as Artifact with Version"
    
    # Step 4: Build and push image
    - task: Bash@3
      condition: eq(variables['deployApp'], 'true')
      displayName: Building Image
      inputs:
        filePath: '$(Pipeline.Workspace)/artifacts/scripts/build-image.sh'
        arguments: >
          ${{ parameters.acr_name }}
          '$(Pipeline.Workspace)/artifacts/Ghost'
          $(Build.BuildId)   