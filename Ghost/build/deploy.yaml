parameters:
- name: acr_name
  type: string
  default: 'acr_name' # Default Azure Container Registry name

trigger: none

pool:
  name: Linux-sh-pool

stages:
- stage: Build
  displayName: "Create Build"
  jobs:
  - job: BuildJob
    displayName: "Build Application"
    variables:
      Build.ArtifactStagingDirectory: $(Pipeline.Workspace)/artifacts
    steps:
    # Step 1: Clone the Ghost Repository
    - script: |
        echo "Cloning Ghost repository..."
        git clone https://github.com/isahurtado97/Ghost.git $(Pipeline.Workspace)/artifacts/Ghost
        echo "Repository cloned successfully."
      displayName: "Clone Ghost Repository"

    # Step 2: Calculate Artifact Version
    - script: |
        echo "Calculating artifact version..."
        echo "##vso[task.setvariable variable=ArtifactVersion]ghost-$(Build.BuildId)"
        echo "Debug: Artifact Version set to ghost-$(Build.BuildId)"
      displayName: "Calculate Artifact Version"

    # Step 3: Publish the Repository as an Artifact
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: $(Pipeline.Workspace)/artifacts/Ghost
        artifact: GhostRepo-$(Build.BuildId) # Use a fixed prefix with dynamic version
      displayName: "Publish Repository as Artifact with Version"
    
    # Step 4: Build and push image
    - task: Bash@3
      displayName: "Building Image and push to ACR"
      inputs:
        filePath: '$(Pipeline.Workspace)/s/Ghost/scripts/bash/build-image.sh'
        arguments: >
          ${{ parameters.acr_name }}
          '$(Pipeline.Workspace)/artifacts/Ghost'
          $(Build.BuildId)   

    # Step 5: Output Tag
    - script: |
        echo "##vso[task.setvariable variable=ImageTag;isOutput=true]ghost-$(Build.BuildId)"
        echo "Debug: Set ImageTag as ghost-$(Build.BuildId)"
      displayName: "Set Output Variable for Image Tag"
